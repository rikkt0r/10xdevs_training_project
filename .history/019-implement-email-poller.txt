❯ /cost                                                                                                                                                                                                                                          
  ⎿  Total cost:            $0.0000                                                                                                                                                                                                              
     Total duration (API):  0s                                                                                                                                                                                                                   
     Total duration (wall): 55s                                                                                                                                                                                                                  
     Total code changes:    0 lines added, 0 lines removed                                                                                                                                                                                       
     Usage:                 0 input, 0 output, 0 cache read, 0 cache write                                                                                                                                                                       
                                                                                                                                                                                                                                                 
❯ /usage                                                                                                                                                                                                                                         
  ⎿  Status dialog dismissed                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                 
❯ /model                                                                                                                                                                                                                                         
  ⎿  Set model to sonnet (claude-sonnet-4-5-20250929)                                                                                                                                                                                            
                                                                                                                                                                                                                                                 
❯ /read-docs                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                 
● I'll read the documentation from the docs directory to understand the project better.                                                                                                                                                          
                                                                                                                                                                                                                                                 
● Search(pattern: "docs/**/*")                                                                                                                                                                                                                   
  ⎿  Found 4 files (ctrl+o to expand)                                                                                                                                                                                                            
                                                                                                                                                                                                                                                 
● Read(docs/PRD.md)                                                                                                                                                                                                                              
  ⎿  Read 461 lines                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                 
● Read(docs/database-schema.md)                                                                                                                                                                                                                  
  ⎿  Read 398 lines                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                 
● Read(docs/api-endpoints.md)                                                                                                                                                                                                                    
  ⎿  Read 1105 lines                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                 
● Read(docs/TODO-backend.md)                                                                                                                                                                                                                     
  ⎿  Read 80 lines                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                 
● I've successfully loaded all documentation from the docs directory. Here's a summary of what I've read:                                                                                                                                        
                                                                                                                                                                                                                                                 
  Project Documentation Loaded                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                 
  1. PRD.md - Product Requirements Document                                                                                                                                                                                                      
                                                                                                                                                                                                                                                 
  Comprehensive specification for a Simple Issue Tracker application including:                                                                                                                                                                  
  - Manager authentication and ticket board management                                                                                                                                                                                           
  - Public ticket creation via web forms and email                                                                                                                                                                                               
  - External platform integration (Jira, Trello)                                                                                                                                                                                                 
  - Email inbox configuration with IMAP/SMTP                                                                                                                                                                                                     
  - Standby queue for unrouted/failed tickets                                                                                                                                                                                                    
  - Tech stack: React/Redux frontend, Python 3.13/FastAPI backend, PostgreSQL database                                                                                                                                                           
                                                                                                                                                                                                                                                 
  2. database-schema.md - Database Schema                                                                                                                                                                                                        
                                                                                                                                                                                                                                                 
  Detailed schema with 10 tables:                                                                                                                                                                                                                
  - managers, manager_tokens, email_inboxes                                                                                                                                                                                                      
  - boards, board_keywords                                                                                                                                                                                                                       
  - tickets, ticket_status_changes, external_tickets                                                                                                                                                                                             
  - standby_queue_items, processed_emails                                                                                                                                                                                                        
  - Includes indexes, constraints, and encryption requirements                                                                                                                                                                                   
                                                                                                                                                                                                                                                 
  3. api-endpoints.md - API Specification                                                                                                                                                                                                        
                                                                                                                                                                                                                                                 
  Complete REST API documentation with 56 endpoints covering:                                                                                                                                                                                    
  - Authentication (register, login, email verification, password reset)                                                                                                                                                                         
  - Manager profile management                                                                                                                                                                                                                   
  - Email inbox configuration with connection testing                                                                                                                                                                                            
  - Board and keyword CRUD operations                                                                                                                                                                                                            
  - Ticket management with state transitions                                                                                                                                                                                                     
  - Standby queue operations                                                                                                                                                                                                                     
  - Public ticket form and viewing                                                                                                                                                                                                               
  - Dashboard statistics                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                 
  4. TODO-backend.md - Implementation Status                                                                                                                                                                                                     
                                                                                                                                                                                                                                                 
  Shows project is ~90% complete with remaining tasks:                                                                                                                                                                                           
  - 2 missing API endpoints for external tickets listing                                                                                                                                                                                         
  - Jira and Trello connectors (currently stubbed)                                                                                                                                                                                               
  - Background email polling engine                                                                                                                                                                                                              
  - Email parsing and routing logic                                                                                                                                                                                                              
                                                                                                                                                                                                                                                 
  All documentation is now in context. How can I help you with this project?                                                                                                                                                                     
                                                                                                                                                                                                                                                 
❯ /cost                                                                                                                                                                                                                                          
  ⎿  Total cost:            $0.2095                                                                                                                                                                                                              
     Total duration (API):  19s                                                                                                                                                                                                                  
     Total duration (wall): 25m 18s                                                                                                                                                                                                              
     Total code changes:    0 lines added, 0 lines removed                                                                                                                                                                                       
     Usage by model:                                                                                                                                                                                                                             
            claude-sonnet:  13 input, 727 output, 48.6k cache read, 49.1k cache write ($0.2095)                                                                                                                                                  
                                                                                                                                                                                                                                                 
❯ implement "Background IMAP Polling Service" from TODO-backend.md.@s                                                                                                                                                                            
  Use APScheduler. We won't be horizontally scaling the app for now.                                                                                                                                                                             
                                                                                                                                                                                                                                                 
● I'll help you implement the Background IMAP Polling Service using APScheduler. This is a substantial feature that requires exploring the existing codebase structure and planning the implementation.                                          
                                                                                                                                                                                                                                                 
● Entered plan mode                                                                                                                                                                                                                              
  Claude is now exploring and designing an implementation approach.                                                                                                                                                                              
                                                                                                                                                                                                                                                 
● I'll explore the codebase to understand the existing structure and then design the implementation plan for the Background IMAP Polling Service.                                                                                                
                                                                                                                                                                                                                                                 
● 3 Explore agents finished (ctrl+o to expand)                                                                                                                                                                                                   
   ├─ Explore backend structure and app initialization · 36 tool uses · 37.7k tokens                                                                                                                                                             
   │  ⎿  Done                                                                                                                                                                                                                                    
   ├─ Explore email inbox implementation · 22 tool uses · 46.6k tokens                                                                                                                                                                           
   │  ⎿  Done                                                                                                                                                                                                                                    
   └─ Explore logging and ticket creation · 41 tool uses · 57.8k tokens                                                                                                                                                                          
      ⎿  Done                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                 
● Now I'll design the implementation plan for the Background IMAP Polling Service.                                                                                                                                                               
                                                                                                                                                                                                                                                 
● Plan(Design IMAP polling service implementation)                                                                                                                                                                                               
  ⎿  Done (18 tool uses · 47.3k tokens · 3m 32s)                                                                                                                                                                                                 
                                                                                                                                                                                                                                                 
● I have a comprehensive understanding from the exploration agents and the detailed design from the Plan agent. Let me now read a few critical files to validate assumptions and then write the final implementation plan.                       
                                                                                                                                                                                                                                                 
● Read(backend/app/main.py)                                                                                                                                                                                                                      
  ⎿  Read 71 lines                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                 
● Read(backend/app/services/email_service.py)                                                                                                                                                                                                    
  ⎿  Read 100 lines                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                 
● Read(backend/app/core/security.py)                                                                                                                                                                                                             
  ⎿  Read 50 lines                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                 
● Read(backend/requirements.txt)                                                                                                                                                                                                                 
  ⎿  Read 45 lines                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                 
● Search(pattern: "generate_unique_ticket_uuid", path: "backend/app/core/security.py", output_mode: "content")                                                                                                                                   
  ⎿  Found 1 line (ctrl+o to expand)                                                                                                                                                                                                             
                                                                                                                                                                                                                                                 
● Search(pattern: "send_ticket_confirmation_email", path: "backend/app/services/email_service.py", output_mode: "content")                                                                                                                       
  ⎿  Found 1 line (ctrl+o to expand)                                                                                                                                                                                                             
  ⎿  Interrupted · What should Claude do instead?                                                                                                                                                                                                
                                                                                                                                                                                                                                                 
❯ /cost                                                                                                                                                                                                                                          
  ⎿  Total cost:            $1.82                                                                                                                                                                                                                
     Total duration (API):  12m 57s                                                                                                                                                                                                              
     Total duration (wall): 34m 56s                                                                                                                                                                                                              
     Total code changes:    129 lines added, 30 lines removed                                                                                                                                                                                    
     Usage by model:                                                                                                                                                                                                                             
            claude-sonnet:  224 input, 29.2k output, 895.2k cache read, 177.3k cache write ($1.37)                                                                                                                                               
             claude-haiku:  25.2k input, 19.6k output, 1.4m cache read, 148.1k cache write ($0.4527)                                                                                                                                             
                                                                                                                                                                                                                                                 
❯ continue                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                 
● Now I'll write the final implementation plan to the plan file.                                                                                                                                                                                 
                                                                                                                                                                                                                                                 
● Updated plan                                                                                                                                                                                                                                   
  ⎿  Wrote 377 lines to ../../.claude/plans/buzzing-roaming-harp.md                                                                                                                                                                              
      1 # Background IMAP Polling Service Implementation Plan                                                                                                                                                                                    
      2 ## Overview                                                                                                                                                                                                                              
      3 Implement a background email polling service using APScheduler to fetch emails from configured IMAP inboxes, route them to appropriate boards based on keywords or exclusive inbox assignments, and handle failures gracefully.          
      4 ## Architecture Summary                                                                                                                                                                                                                  
      5 ### Components                                                                                                                                                                                                                           
      6 1. **APScheduler Integration** - AsyncIOScheduler integrated with FastAPI lifecycle                                                                                                                                                      
      7 2. **Email Polling Service** - Core service for IMAP connection, email parsing, and routing                                                                                                                                              
     … +367 lines (ctrl+o to expand)                                                                                                                                                                                                             
                                                                                                                                                                                                                                                 
─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
 Ready to code?                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                 
 Here is Claude's plan:                                                                                                                                                                                                                          
╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌
 Background IMAP Polling Service Implementation Plan                                                                                                                                                                                             
                                                                                                                                                                                                                                                 
 Overview                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                 
 Implement a background email polling service using APScheduler to fetch emails from configured IMAP inboxes, route them to appropriate boards based on keywords or exclusive inbox assignments, and handle failures gracefully.                 
                                                                                                                                                                                                                                                 
 Architecture Summary                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                 
 Components                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                 
 1. APScheduler Integration - AsyncIOScheduler integrated with FastAPI lifecycle                                                                                                                                                                 
 2. Email Polling Service - Core service for IMAP connection, email parsing, and routing                                                                                                                                                         
 3. Dynamic Job Management - Add/update/remove jobs when inbox config changes                                                                                                                                                                    
 4. Email Routing - Three-tier priority: exclusive inbox → keyword matching → standby queue                                                                                                                                                      
                                                                                                                                                                                                                                                 
 Key Design Decisions                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                 
 - Scheduler Type: AsyncIOScheduler (in-memory, no persistence) - jobs recreated from DB on startup                                                                                                                                              
 - Connection Strategy: New IMAP connection per poll (no pooling) - simpler, no stale connections                                                                                                                                                
 - Concurrency: max_instances=1 per inbox job - prevents duplicate processing                                                                                                                                                                    
 - Email Marking: Mark as SEEN immediately after processing to prevent reprocessing                                                                                                                                                              
                                                                                                                                                                                                                                                 
 Files to Create                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                 
 1. /backend/app/services/email_polling_service.py (~500 lines)                                                                                                                                                                                  
                                                                                                                                                                                                                                                 
 Main email polling service implementation.                                                                                                                                                                                                      
                                                                                                                                                                                                                                                 
 Key Classes/Functions:                                                                                                                                                                                                                          
 - EmailPollingService class with methods:                                                                                                                                                                                                       
   - poll_inbox(inbox_id) - Main async job function called by scheduler                                                                                                                                                                          
   - _connect_imap() - Establish IMAP connection with aioimaplib                                                                                                                                                                                 
   - _fetch_unread_emails() - Fetch UNSEEN emails from INBOX folder                                                                                                                                                                              
   - _parse_email() - Extract sender, subject, body from raw email bytes                                                                                                                                                                         
   - _strip_html() - Convert HTML to plain text using BeautifulSoup                                                                                                                                                                              
   - _hash_subject() - SHA-256 hash for duplicate detection                                                                                                                                                                                      
   - _is_duplicate() - Check ProcessedEmail within threshold                                                                                                                                                                                     
   - _route_email() - Route by priority: exclusive inbox → keywords → standby                                                                                                                                                                    
   - _create_ticket() - Create ticket and send confirmation email                                                                                                                                                                                
   - _create_standby_queue_item() - Add to standby queue on no match                                                                                                                                                                             
   - _mark_processed() - Record in ProcessedEmail table                                                                                                                                                                                          
 - initialize_polling_jobs(scheduler) - Load active inboxes and create jobs on startup                                                                                                                                                           
 - add_polling_job(scheduler, inbox_id, interval) - Add/update job for inbox                                                                                                                                                                     
 - remove_polling_job(scheduler, inbox_id) - Remove job for inbox                                                                                                                                                                                
                                                                                                                                                                                                                                                 
 Email Routing Logic:                                                                                                                                                                                                                            
 1. Priority 1: Check if inbox has exclusive board assignment → create ticket on that board                                                                                                                                                      
 2. Priority 2: Check keywords (case-insensitive) in email subject → create ticket on matching board                                                                                                                                             
 3. Priority 3: No match → create StandbyQueueItem with failure_reason='no_keyword_match'                                                                                                                                                        
                                                                                                                                                                                                                                                 
 Error Handling:                                                                                                                                                                                                                                 
 - IMAP connection failures: Log error, skip poll, retry on next interval                                                                                                                                                                        
 - Email parsing errors: Log error, skip email, continue with others                                                                                                                                                                             
 - Duplicate emails: Log info, mark as read, skip                                                                                                                                                                                                
 - Ticket creation failures: Log error, send to standby queue                                                                                                                                                                                    
                                                                                                                                                                                                                                                 
 2. /backend/app/services/tests/test_email_polling_service.py (~400 lines)                                                                                                                                                                       
                                                                                                                                                                                                                                                 
 Unit tests for email polling service.                                                                                                                                                                                                           
                                                                                                                                                                                                                                                 
 Test Coverage:                                                                                                                                                                                                                                  
 - HTML stripping (plain text output from HTML input)                                                                                                                                                                                            
 - Subject hashing (consistent SHA-256)                                                                                                                                                                                                          
 - Email parsing (plain text, HTML, multipart)                                                                                                                                                                                                   
 - Duplicate detection (within/outside threshold)                                                                                                                                                                                                
 - Email routing (exclusive inbox, keyword match, standby queue)                                                                                                                                                                                 
 - Keyword case-insensitivity                                                                                                                                                                                                                    
 - Ticket creation with confirmation email                                                                                                                                                                                                       
 - Title truncation to 255 chars                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                 
 3. /backend/app/services/tests/test_email_polling_integration.py (~200 lines)                                                                                                                                                                   
                                                                                                                                                                                                                                                 
 Integration tests with mocked IMAP.                                                                                                                                                                                                             
                                                                                                                                                                                                                                                 
 Test Scenarios:                                                                                                                                                                                                                                 
 - End-to-end poll with ticket creation                                                                                                                                                                                                          
 - Duplicate email handling                                                                                                                                                                                                                      
 - Standby queue routing                                                                                                                                                                                                                         
 - IMAP connection failure graceful handling                                                                                                                                                                                                     
 - Multiple emails in single poll                                                                                                                                                                                                                
                                                                                                                                                                                                                                                 
 Files to Modify                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                 
 1. /backend/requirements.txt                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                 
 Add two dependencies:                                                                                                                                                                                                                           
 APScheduler==3.10.4                                                                                                                                                                                                                             
 beautifulsoup4==4.12.3                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                 
 2. /backend/app/main.py                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                 
 Integrate APScheduler with FastAPI lifecycle.                                                                                                                                                                                                   
                                                                                                                                                                                                                                                 
 Changes:                                                                                                                                                                                                                                        
 # Add imports                                                                                                                                                                                                                                   
 from apscheduler.schedulers.asyncio import AsyncIOScheduler                                                                                                                                                                                     
                                                                                                                                                                                                                                                 
 # Create scheduler instance (after app creation, before middleware)                                                                                                                                                                             
 scheduler = AsyncIOScheduler(timezone="UTC")                                                                                                                                                                                                    
                                                                                                                                                                                                                                                 
 # Modify startup_event()                                                                                                                                                                                                                        
 @app.on_event("startup")                                                                                                                                                                                                                        
 async def startup_event():                                                                                                                                                                                                                      
     logger.info(f"Starting {settings.PROJECT_NAME} v{settings.VERSION}")                                                                                                                                                                        
     logger.info(f"Environment: {settings.APP_ENV}")                                                                                                                                                                                             
                                                                                                                                                                                                                                                 
     # Start scheduler                                                                                                                                                                                                                           
     scheduler.start()                                                                                                                                                                                                                           
     logger.info("APScheduler started")                                                                                                                                                                                                          
                                                                                                                                                                                                                                                 
     # Initialize email polling jobs                                                                                                                                                                                                             
     from app.services.email_polling_service import initialize_polling_jobs                                                                                                                                                                      
     await initialize_polling_jobs(scheduler)                                                                                                                                                                                                    
     logger.info("Email polling jobs initialized")                                                                                                                                                                                               
                                                                                                                                                                                                                                                 
 # Modify shutdown_event()                                                                                                                                                                                                                       
 @app.on_event("shutdown")                                                                                                                                                                                                                       
 async def shutdown_event():                                                                                                                                                                                                                     
     logger.info("Shutting down application")                                                                                                                                                                                                    
                                                                                                                                                                                                                                                 
     # Shutdown scheduler gracefully                                                                                                                                                                                                             
     scheduler.shutdown(wait=True)                                                                                                                                                                                                               
     logger.info("APScheduler shut down")                                                                                                                                                                                                        
                                                                                                                                                                                                                                                 
 3. /backend/app/api/endpoints/email_inboxes.py                                                                                                                                                                                                  
                                                                                                                                                                                                                                                 
 Add dynamic job management to inbox CRUD endpoints.                                                                                                                                                                                             
                                                                                                                                                                                                                                                 
 Changes:                                                                                                                                                                                                                                        
 # Add imports                                                                                                                                                                                                                                   
 from app.main import scheduler                                                                                                                                                                                                                  
 from app.services.email_polling_service import add_polling_job, remove_polling_job                                                                                                                                                              
                                                                                                                                                                                                                                                 
 # Modify create_inbox() - add job if active                                                                                                                                                                                                     
 @router.post("", status_code=status.HTTP_201_CREATED)                                                                                                                                                                                           
 async def create_inbox(...):                                                                                                                                                                                                                    
     inbox = email_inbox_service.create_inbox(...)                                                                                                                                                                                               
                                                                                                                                                                                                                                                 
     # Add polling job if inbox is active                                                                                                                                                                                                        
     if inbox.is_active:                                                                                                                                                                                                                         
         await add_polling_job(scheduler, inbox.id, inbox.polling_interval)                                                                                                                                                                      
                                                                                                                                                                                                                                                 
     return DataResponse[EmailInboxResponse](data=inbox)                                                                                                                                                                                         
                                                                                                                                                                                                                                                 
 # Modify update_inbox() - reschedule if interval/active changed                                                                                                                                                                                 
 @router.put("/{inbox_id}", status_code=status.HTTP_200_OK)                                                                                                                                                                                      
 async def update_inbox(...):                                                                                                                                                                                                                    
     old_inbox = email_inbox_service.get_inbox(db, current_manager, inbox_id)                                                                                                                                                                    
     inbox = email_inbox_service.update_inbox(...)                                                                                                                                                                                               
                                                                                                                                                                                                                                                 
     # Handle job rescheduling                                                                                                                                                                                                                   
     if request.is_active is not None or request.polling_interval is not None:                                                                                                                                                                   
         if inbox.is_active:                                                                                                                                                                                                                     
             await add_polling_job(scheduler, inbox.id, inbox.polling_interval)                                                                                                                                                                  
         elif old_inbox.is_active and not inbox.is_active:                                                                                                                                                                                       
             await remove_polling_job(scheduler, inbox.id)                                                                                                                                                                                       
                                                                                                                                                                                                                                                 
     return DataResponse[EmailInboxResponse](data=inbox)                                                                                                                                                                                         
                                                                                                                                                                                                                                                 
 # Modify delete_inbox() - remove job before deletion                                                                                                                                                                                            
 @router.delete("/{inbox_id}", status_code=status.HTTP_204_NO_CONTENT)                                                                                                                                                                           
 async def delete_inbox(...):                                                                                                                                                                                                                    
     await remove_polling_job(scheduler, inbox_id)                                                                                                                                                                                               
     email_inbox_service.delete_inbox(...)                                                                                                                                                                                                       
                                                                                                                                                                                                                                                 
 Implementation Details                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                 
 IMAP Connection                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                 
 # Use aioimaplib (already in requirements.txt)                                                                                                                                                                                                  
 if inbox.imap_use_ssl:                                                                                                                                                                                                                          
     imap = aioimaplib.AIOIMAP4_SSL(host=inbox.imap_host, port=inbox.imap_port)                                                                                                                                                                  
 else:                                                                                                                                                                                                                                           
     imap = aioimaplib.AIOIMAP4(host=inbox.imap_host, port=inbox.imap_port)                                                                                                                                                                      
                                                                                                                                                                                                                                                 
 await imap.wait_hello_from_server()                                                                                                                                                                                                             
 password = decrypt_data(inbox.imap_password_encrypted)                                                                                                                                                                                          
 await imap.login(inbox.imap_username, password)                                                                                                                                                                                                 
 await imap.select('INBOX')                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                 
 Email Fetching                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                 
 # Search for unread emails                                                                                                                                                                                                                      
 status, messages = await imap.search('UNSEEN')                                                                                                                                                                                                  
 message_ids = messages[0].split()                                                                                                                                                                                                               
                                                                                                                                                                                                                                                 
 for msg_id in message_ids:                                                                                                                                                                                                                      
     status, data = await imap.fetch(msg_id, '(RFC822)')                                                                                                                                                                                         
     raw_email = data[1]                                                                                                                                                                                                                         
     # Process email...                                                                                                                                                                                                                          
     # Mark as read                                                                                                                                                                                                                              
     await imap.store(msg_id, '+FLAGS', '\\Seen')                                                                                                                                                                                                
                                                                                                                                                                                                                                                 
 Email Parsing                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                 
 from email import message_from_bytes                                                                                                                                                                                                            
 from email.header import decode_header                                                                                                                                                                                                          
                                                                                                                                                                                                                                                 
 msg = message_from_bytes(raw_email)                                                                                                                                                                                                             
 message_id = msg.get('Message-ID', '')                                                                                                                                                                                                          
 sender = msg.get('From', '')  # Parse "Name <email>" to extract email                                                                                                                                                                           
 subject = decode_header(msg.get('Subject', ''))[0]  # Decode if needed                                                                                                                                                                          
                                                                                                                                                                                                                                                 
 # Extract body (prefer text/plain, fallback to text/html with stripping)                                                                                                                                                                        
 if msg.is_multipart():                                                                                                                                                                                                                          
     for part in msg.walk():                                                                                                                                                                                                                     
         if part.get_content_type() == "text/plain":                                                                                                                                                                                             
             body = part.get_payload(decode=True).decode('utf-8')                                                                                                                                                                                
             break                                                                                                                                                                                                                               
         elif part.get_content_type() == "text/html":                                                                                                                                                                                            
             html = part.get_payload(decode=True).decode('utf-8')                                                                                                                                                                                
             body = strip_html(html)  # BeautifulSoup                                                                                                                                                                                            
                                                                                                                                                                                                                                                 
 Duplicate Detection                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                 
 subject_hash = hashlib.sha256(subject.encode('utf-8')).hexdigest()                                                                                                                                                                              
 threshold = datetime.now(timezone.utc) - timedelta(minutes=settings.DUPLICATE_EMAIL_THRESHOLD_MINUTES)                                                                                                                                          
                                                                                                                                                                                                                                                 
 existing = db.query(ProcessedEmail).filter(                                                                                                                                                                                                     
     ProcessedEmail.inbox_id == inbox_id,                                                                                                                                                                                                        
     ProcessedEmail.sender_email == sender,                                                                                                                                                                                                      
     ProcessedEmail.subject_hash == subject_hash,                                                                                                                                                                                                
     ProcessedEmail.processed_at >= threshold                                                                                                                                                                                                    
 ).first()                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                 
 if existing:                                                                                                                                                                                                                                    
     return True  # Skip duplicate                                                                                                                                                                                                               
                                                                                                                                                                                                                                                 
 Job Scheduling                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                 
 from apscheduler.triggers.interval import IntervalTrigger                                                                                                                                                                                       
                                                                                                                                                                                                                                                 
 scheduler.add_job(                                                                                                                                                                                                                              
     func=email_polling_service.poll_inbox,                                                                                                                                                                                                      
     trigger=IntervalTrigger(minutes=polling_interval),                                                                                                                                                                                          
     args=[inbox_id],                                                                                                                                                                                                                            
     id=f"poll_inbox_{inbox_id}",                                                                                                                                                                                                                
     name=f"Poll inbox {inbox_id} every {polling_interval} min",                                                                                                                                                                                 
     replace_existing=True,                                                                                                                                                                                                                      
     max_instances=1  # Prevent concurrent polling of same inbox                                                                                                                                                                                 
 )                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                 
 Verification Steps                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                 
 Manual Testing                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                 
 1. Setup:                                                                                                                                                                                                                                       
   - Install dependencies: cd backend && pip install APScheduler beautifulsoup4                                                                                                                                                                  
   - Configure test email inbox (Gmail with app password recommended)                                                                                                                                                                            
   - Create board with keyword matching inbox subject                                                                                                                                                                                            
 2. Test Exclusive Inbox Routing:                                                                                                                                                                                                                
   - Create board with exclusive_inbox_id set                                                                                                                                                                                                    
   - Send email to that inbox                                                                                                                                                                                                                    
   - Verify ticket created on correct board                                                                                                                                                                                                      
   - Verify confirmation email sent                                                                                                                                                                                                              
   - Verify ProcessedEmail record created                                                                                                                                                                                                        
 3. Test Keyword Routing:                                                                                                                                                                                                                        
   - Create board with keyword (e.g., "urgent")                                                                                                                                                                                                  
   - Send email with "URGENT: Server down" subject                                                                                                                                                                                               
   - Verify case-insensitive matching works                                                                                                                                                                                                      
   - Verify ticket created                                                                                                                                                                                                                       
 4. Test Standby Queue:                                                                                                                                                                                                                          
   - Send email with no matching keywords or exclusive inbox                                                                                                                                                                                     
   - Verify StandbyQueueItem created with failure_reason='no_keyword_match'                                                                                                                                                                      
 5. Test Duplicate Detection:                                                                                                                                                                                                                    
   - Send same email twice within 60 minutes                                                                                                                                                                                                     
   - Verify only one ticket created                                                                                                                                                                                                              
   - Check logs for "Skipping duplicate email"                                                                                                                                                                                                   
 6. Test Job Management:                                                                                                                                                                                                                         
   - Create active inbox → verify job appears in scheduler                                                                                                                                                                                       
   - Update polling_interval → verify job rescheduled                                                                                                                                                                                            
   - Deactivate inbox → verify job removed                                                                                                                                                                                                       
   - Delete inbox → verify job removed                                                                                                                                                                                                           
                                                                                                                                                                                                                                                 
 Unit Tests                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                 
 cd backend                                                                                                                                                                                                                                      
 pytest app/services/tests/test_email_polling_service.py -v                                                                                                                                                                                      
 pytest app/services/tests/test_email_polling_integration.py -v                                                                                                                                                                                  
                                                                                                                                                                                                                                                 
 Integration Test                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                 
 # Run full test suite                                                                                                                                                                                                                           
 pytest app/services/tests/ -v --cov=app/services/email_polling_service                                                                                                                                                                          
                                                                                                                                                                                                                                                 
 Monitoring                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                 
 Check logs for:                                                                                                                                                                                                                                 
 - "APScheduler started"                                                                                                                                                                                                                         
 - "Email polling jobs initialized"                                                                                                                                                                                                              
 - "Added polling job for inbox X (interval: Y min)"                                                                                                                                                                                             
 - "Starting poll for inbox X"                                                                                                                                                                                                                   
 - "Successfully processed email into ticket Y"                                                                                                                                                                                                  
 - Any ERROR level logs indicating failures                                                                                                                                                                                                      
                                                                                                                                                                                                                                                 
 Dependencies                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                 
 New Python Packages:                                                                                                                                                                                                                            
 - APScheduler==3.10.4 - Background job scheduling                                                                                                                                                                                               
 - beautifulsoup4==4.12.3 - HTML stripping                                                                                                                                                                                                       
                                                                                                                                                                                                                                                 
 Existing Packages (already available):                                                                                                                                                                                                          
 - aioimaplib==1.0.1 - Async IMAP client                                                                                                                                                                                                         
 - aiosmtplib==3.0.1 - Async SMTP client (for confirmation emails)                                                                                                                                                                               
 - cryptography==42.0.0 - For decrypting IMAP passwords                                                                                                                                                                                          
                                                                                                                                                                                                                                                 
 Configuration                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                 
 Environment Variables (already defined):                                                                                                                                                                                                        
 - ENCRYPTION_KEY - Used to decrypt IMAP passwords                                                                                                                                                                                               
 - DUPLICATE_EMAIL_THRESHOLD_MINUTES - Default 60 minutes                                                                                                                                                                                        
 - SMTP_DEFAULT_* - For sending confirmation emails                                                                                                                                                                                              
                                                                                                                                                                                                                                                 
 Database Tables (already exist):                                                                                                                                                                                                                
 - email_inboxes - Stores IMAP config with encrypted passwords                                                                                                                                                                                   
 - processed_emails - Tracks processed emails for deduplication                                                                                                                                                                                  
 - boards - Has exclusive_inbox_id for routing                                                                                                                                                                                                   
 - board_keywords - Keywords for subject matching                                                                                                                                                                                                
 - tickets - Where emails become tickets                                                                                                                                                                                                         
 - standby_queue_items - For unrouted emails                                                                                                                                                                                                     
                                                                                                                                                                                                                                                 
 Trade-offs                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                 
 In-Memory Scheduler (No Persistence)                                                                                                                                                                                                            
                                                                                                                                                                                                                                                 
 Pros: Simpler, jobs self-heal from database, no stale job issues                                                                                                                                                                                
 Cons: Jobs lost on crash (acceptable - 1-15 min intervals make recovery fast)                                                                                                                                                                   
                                                                                                                                                                                                                                                 
 No IMAP Connection Pooling                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                 
 Pros: No stale connections, simpler error recovery                                                                                                                                                                                              
 Cons: Connection overhead per poll (negligible with 1-15 min intervals)                                                                                                                                                                         
                                                                                                                                                                                                                                                 
 max_instances=1 Per Job                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                 
 Pros: Prevents concurrent polling and duplicate processing                                                                                                                                                                                      
 Cons: If poll takes longer than interval, next poll is skipped (acceptable - better than duplicates)                                                                                                                                            
                                                                                                                                                                                                                                                 
 Implementation Order                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                 
 1. Phase 1: Core service file                                                                                                                                                                                                                   
   - Create email_polling_service.py with helper methods                                                                                                                                                                                         
   - Implement email parsing and HTML stripping                                                                                                                                                                                                  
   - Implement duplicate detection logic                                                                                                                                                                                                         
 2. Phase 2: Email processing                                                                                                                                                                                                                    
   - Implement IMAP connection and email fetching                                                                                                                                                                                                
   - Implement routing logic (exclusive → keywords → standby)                                                                                                                                                                                    
   - Implement ticket creation flow                                                                                                                                                                                                              
 3. Phase 3: Scheduler integration                                                                                                                                                                                                               
   - Add scheduler to main.py                                                                                                                                                                                                                    
   - Implement job management functions                                                                                                                                                                                                          
   - Modify inbox endpoints for dynamic job management                                                                                                                                                                                           
 4. Phase 4: Testing                                                                                                                                                                                                                             
   - Write unit tests                                                                                                                                                                                                                            
   - Write integration tests                                                                                                                                                                                                                     
   - Manual testing with real IMAP server                                                                                                                                                                                                        
 5. Phase 5: Verification                                                                                                                                                                                                                        
   - Test all routing scenarios                                                                                                                                                                                                                  
   - Monitor logs for errors                                                                                                                                                                                                                     
   - Verify no duplicate processing                                                                                                                                                                                                              
                                                                                                                                                                                                                                                 
 Critical Files                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                 
 1. backend/app/services/email_polling_service.py - Core implementation (NEW)                                                                                                                                                                    
 2. backend/app/main.py - Scheduler lifecycle (MODIFY)                                                                                                                                                                                           
 3. backend/app/api/endpoints/email_inboxes.py - Dynamic job management (MODIFY)                                                                                                                                                                 
 4. backend/requirements.txt - Dependencies (MODIFY)                                                                                                                                                                                             
 5. backend/app/services/tests/test_email_polling_service.py - Tests (NEW)   
